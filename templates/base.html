<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{% block title %}ByeByeLastMinute{% endblock %}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <header class="site-header">
    <h1>ByeByeLastMinute</h1>
    <nav class="navbar">
      <a href="{{ url_for('dashboard') }}">Dashboard</a>
      <a href="{{ url_for('index') }}">Class Management</a>
      <a href="{{ url_for('timetable') }}">Timetable</a>
      <a href="{{ url_for('todos') }}">To-Do List</a>
      <a href="{{ url_for('calendar_view') }}"> Calendar</a>

    </nav>
  </header>

  <main class="container">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-messages">
          {% for category, message in messages %}
            <div class="flash {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
  </main>

  <!-- Request Notification Permission -->
  <script>
    if ("Notification" in window) {
      if (Notification.permission !== "granted" && Notification.permission !== "denied") {
        Notification.requestPermission().then(permission => {
          console.log("Notification permission:", permission);
        });
      }
    }
  </script>

  <!-- Register Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/static/service-worker.js')
      .then(reg => console.log('Service Worker registered', reg))
      .catch(err => console.error('SW registration failed', err));
    }
  </script>

  <!-- Poll due tasks -->
  <script>
    const notifiedTasks = JSON.parse(localStorage.getItem("notifiedTasks") || "[]");

    async function checkDueTasks() {
      try {
        const response = await fetch("/todos/check");
        const data = await response.json();

        data.tasks.forEach(task => {
          if (!notifiedTasks.includes(task)) {
            if ("Notification" in window && Notification.permission === "granted") {
              new Notification("Task Due Today!", {
                body: task,
                icon: "{{ url_for('static', filename='icon.png') }}",
                requireInteraction: true
              });
            }
            notifiedTasks.push(task);
          }
        });

        localStorage.setItem("notifiedTasks", JSON.stringify(notifiedTasks));
      } catch (err) {
        console.error("Error checking due tasks:", err);
      }
    }

    setInterval(checkDueTasks, 60000); // every 1 min
    checkDueTasks(); // immediate check
  </script>

  <!-- Push subscription -->
  <script>
    // Needed to convert VAPID key for PushManager
    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
      const rawData = atob(base64);
      return Uint8Array.from([...rawData].map(c => c.charCodeAt(0)));
    }

    async function subscribeUser() {
      console.log("üöÄ Starting subscription process...");

      if (!("serviceWorker" in navigator && "PushManager" in window)) {
        console.log("‚ùå Push not supported");
        return;
      }

      try {
        const reg = await navigator.serviceWorker.ready;
        console.log("‚úÖ Service Worker ready");

        let sub = await reg.pushManager.getSubscription();
        console.log("üì° Current subscription:", sub);

        if (!sub) {
          console.log("üîê Subscribing with VAPID key...");
          const vapidKey = "{{ VAPID_PUBLIC_KEY }}";
          if (!vapidKey || vapidKey.includes("VAPID")) {
            console.error("‚ùå VAPID_PUBLIC_KEY not injected! Check Flask context_processor.");
            return;
          }

          sub = await reg.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(vapidKey)
          });
          console.log("‚úÖ Subscribed!", sub);
        }

        console.log("üì§ Sending subscription to backend...");
        const response = await fetch("/subscribe", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(sub)
        });

        if (response.ok) {
          console.log("‚úÖ Subscription sent to Flask!");
        } else {
          console.error("‚ùå Failed to send subscription:", await response.text());
        }
      } catch (err) {
        console.error("üí• Subscription error:", err);
      }
    }

    // Run subscription
    subscribeUser();
  </script>
</body>
</html>